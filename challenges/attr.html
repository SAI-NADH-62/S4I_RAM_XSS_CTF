<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Attribute â€” XSS CTF</title>
  <link rel="stylesheet" href="/assets/style.css">
  <style>
    main { max-width:900px; margin:2rem auto; padding:1rem; }
    .vuln-box { background: rgba(255,255,255,0.02); padding:1rem; border-radius:10px; border:1px solid rgba(255,255,255,0.03); }
    .input-row { display:flex; gap:8px; margin:0.75rem 0; align-items:center; }
    input.msg { flex:1; padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:transparent; color:inherit; }
    button.go { padding:8px 12px; border-radius:8px; border:none; background: linear-gradient(90deg,#e11d48,#ff6b8a); color:#fff; font-weight:600; }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container header-inner">
      <div class="brand"><strong>XSS</strong> CTF <span class="tag">attribute</span></div>
      <nav class="top-nav"><a href="/index.html">Home</a></nav>
    </div>
  </header>

  <main>
    <div class="container">
      <h1>Attribute / Event XSS</h1>
      <p class="lead">Definition: Attribute XSS happens when user input is inserted into an HTML attribute without proper escaping, letting attackers run JavaScript when the element is interacted with.</p>
      <p class="lead">Impact: Injected event attributes run when a user interacts with the element - steal session tokens, perform actions as the user, exfiltrate data, or plant persistent hooks.</p>

      <div class="vuln-box">
        <div class="input-row">
          <input id="payload" class="msg" placeholder='Type your name' />
          <button id="apply" class="go">Apply</button>
        </div>

        <div id="demo">Demo: <a id="vulnLink" href="#">Hover me</a></div>
        <div class="hint">Tip: Trigger a fetch request containing the text "ATTR" to reveal the flag. </div>
      </div>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container"><small>CTF lab - intentional vulnerabilities only</small></div>
  </footer>

  <script>
    // Page token
    window.ctf_token = "attr-token-SILVER4";

    const input = document.getElementById('payload');
    const applyBtn = document.getElementById('apply');
    const demo = document.getElementById('demo');
    let claimed = false;

    function updateQueryName(val){
      const params = new URLSearchParams(location.search);
      if (val) params.set('name', val); else params.delete('name');
      const newQs = params.toString();
      const newUrl = location.pathname + (newQs ? '?' + newQs : '') + location.hash;
      history.replaceState(null, '', newUrl);
    }

    function injectName(val){
      // intentionally vulnerable: put into attribute via innerHTML so attributes can be injected
      demo.innerHTML = 'Demo: <a id="vulnLink" href="#" title="' + val + '">Hover me</a>';
      // rebind link reference
      const newLink = document.getElementById('vulnLink');

      // Detect if the injected attribute contains a fetch('/ATTR') call,
      // and also detect generic onmouseover/onclick attributes.
      // If we detect fetch('/ATTR') explicitly in the attribute text, trigger claim.
      if (newLink) {
        const titleAttr = newLink.getAttribute('title') || '';
        const onmouseoverAttr = newLink.getAttribute('onmouseover') || '';
        const onclickAttr = newLink.getAttribute('onclick') || '';

        // If the injected *attribute string* contains the pattern fetch('/ATTR'),
        // treat it as the deliberate test payload and claim the flag.
        if (titleAttr.includes("fetch('/ATTR')") || onmouseoverAttr.includes("fetch('/ATTR')") || onclickAttr.includes("fetch('/ATTR')")) {
          // small timeout so any injected handler runs first if present
          setTimeout(()=> claimFlag('ATTR'), 150);
          return;
        }

        // If there's an onmouseover/onclick handler, attach a listener to claim on hover/click
        if ((newLink.getAttribute('onmouseover') || newLink.getAttribute('onclick')) && !claimed) {
          const handler = function(){
            newLink.removeEventListener('mouseover', handler);
            newLink.removeEventListener('click', handler);
            setTimeout(()=> claimFlag('ATTR'), 150);
          };
          newLink.addEventListener('mouseover', handler);
          newLink.addEventListener('click', handler);
        }
      }
    }

    async function claimFlag(name){
      if (claimed) return;
      claimed = true;
      try {
        const r = await fetch('/api/claim', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ token: window.ctf_token, challenge: name })});
        if (!r.ok) {
          const err = await r.json().catch(()=>({error:'unknown'}));
          alert('Claim failed: ' + (err.error || r.status));
          return;
        }
        const j = await r.json();
        alert('FLAG: ' + j.flag);
      } catch(e){ alert('Error contacting /api/claim: ' + e.message); }
    }

    (function initFromQuery(){
      const p = new URLSearchParams(location.search).get('name') || '';
      if (p) { input.value = p; injectName(p); }
    })();

    applyBtn.addEventListener('click', ()=>{ const v = input.value; updateQueryName(v); injectName(v); input.focus(); });
    input.addEventListener('keydown', (e)=> { if (e.key === 'Enter'){ e.preventDefault(); applyBtn.click(); } });
  </script>
</body>
</html>
